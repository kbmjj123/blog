---
title: Sentryå‰ç«¯/APPæ—¥å¿—ç›‘æ§çš„ä½¿ç”¨
author: Zhenggl
date: 2022-02-14 14:23:28
categories:
    - [å‰ç«¯,æ—¥å¿—ç›‘æ§]
tags:
    - å‰ç«¯
    - æ—¥å¿—ç›‘æ§
    - Sentry
cover_picture: sentry-cover.jpeg
---

### å‰è¨€
ä¸ºæé«˜å‰ç«¯å¿«é€Ÿå®šä½çº¿ä¸Šé—®é¢˜ï¼Œå‡å°‘è·Ÿç”¨æˆ·/æµ‹è¯•æ‹¿è´¦å·+å¯†ç è¿›è¡Œbugçš„é‡ç°ï¼Œè¿™è¾¹åˆ©ç”¨Sentryæ¥æ­å»ºäº†å†…éƒ¨çš„ä¸€å¥—æ—¥å¿—ç›‘æ§ç³»ç»Ÿï¼Œç›®å‰å¯ä»¥æ»¡è¶³äºAPP + WEB/H5ç«¯ + å°ç¨‹åºçš„ä¸€ä¸ªæ—¥å¿—ç›‘æ§æœåŠ¡ï¼Œ
è®°å½•çº¿ä¸Šç¨‹åºè„šæœ¬å¼‚å¸¸ï¼Œé€šè¿‡æ”¶é›†æµè§ˆå™¨ç›¸å…³ä¿¡æ¯ç¯å¢ƒï¼Œä¸”é’ˆå¯¹ä¸šåŠ¡æ–¹é¢çš„å¼‚å¸¸è¿›è¡Œæ•°æ®çš„é‡‡é›†ï¼Œå¹¶æäº¤åˆ°æ—¥å¿—æœåŠ¡å™¨ä¸­ï¼Œæä¾›é‚®ç®±å‘Šè­¦æœºåˆ¶ï¼Œä¸»åŠ¨å¿«é€Ÿå“åº”å¤„ç†çº¿ä¸Šé—®é¢˜ï¼Œä¿è¯çº¿ä¸Šé—®é¢˜çš„æ­£å¸¸è¿ä½œã€‚
è®¿é—®åœ°å€ï¼š[https://monitor.zhidianlife.com/](https://monitor.zhidianlife.com/)

### ä¸€ã€è´¦å·æ³¨å†Œ(å…¬å¸é‚®ç®±)
1. æ³¨å†Œå…¬å¸é‚®ç®±è´¦å·ï¼Œ[ç‚¹æˆ‘æŸ¥çœ‹æ³¨å†Œæµç¨‹](http://zims.zhidianlife.com/ps/my/docInfo.html?id=51db2689f0d14b35a60a9ad8aacbe0f8)
2. è¿›å…¥sentryç½‘ç«™ï¼Œç‚¹å‡»`è¯·æ±‚åŠ å…¥`å…¥å£ï¼Œç„¶åè¾“å…¥å®Œæ•´åœ°å€ï¼Œå®ŒæˆåŠ å…¥ç”³è¯·æ“ä½œ

![è¯·æ±‚åŠ å…¥](https://img2.zhidianlife.com/image/2022/02/17/3d7c7b11-81ec-416a-82e9-3a1d582307dc.png)

3. å¾…è¯·æ±‚åŠ å…¥æˆåŠŸåï¼Œé‡æ–°è¿›å…¥sentryï¼Œç„¶åç‚¹å‡»`å¯†ç ä¸¢å¤±`ï¼Œå®Œæˆå¯†ç è®¾ç½®æµç¨‹
4. æ ¹æ®è‡ªè¡Œç»´æŠ¤çš„è´¦å·å¯†ç ï¼Œç™»å½•è¿›å…¥ç³»ç»Ÿ
5. è¿›å…¥ç³»ç»Ÿåï¼Œéœ€è¦é…ç½®å¯¹åº”çš„è§†å›¾å±•ç¤º
   - è®¾ç½®æµè§ˆçš„è¯­è¨€ä»¥åŠæ—¶åŒº

   ![è¿›å…¥ä¸ªäººè®¾ç½®](https://img2.zhidianlife.com/image/2022/02/17/a2184947-9d3b-4b93-b42b-1dfc1177ed84.png)

   ![æ›´æ”¹å±•ç¤ºä¸æ—¶åŒº](https://img2.zhidianlife.com/image/2022/02/17/4a783c45-c498-475e-89e2-f83dd2d5edc6.png)

   - é‡æ–°éªŒè¯è‡ªå·±çš„é‚®ç®±è´¦å·

   ![éªŒè¯é‚®ç®±](https://img2.zhidianlife.com/image/2022/02/17/c387a049-ba2a-49c4-a711-cc1e1894136b.png)


### äºŒã€é¡¹ç›®æ¥å…¥(Vue)
*ç”±äºç›®å‰çš„é¡¹ç›®å¤§éƒ½ä½¿ç”¨çš„vueå¼€å‘æ¡†æ¶ï¼Œå› æ­¤è¿™è¾¹å‰ç«¯æš‚æ—¶ä»…æä¾›vueçš„ä½¿ç”¨*
1. å®‰è£…ä¾èµ–
```shell script
  npm install --save @sentry/vue @sentry/tracing
```

2. å…¥å£æ–‡ä»¶`main.js`çš„å¼•å…¥
```javascript
  import * as Sentry from '@sentry/vue';
  import { Integrations } from '@sentry/tracing';
  // ç„¶åæ˜¯æ—¥å¿—æœåŠ¡çš„åˆå§‹åŒ–
  Sentry.init({
      Vue,
      dsn: "http://6ce276ed6d5f43bea71464a0efee522a@192.168.199.25:9000/2",
      integrations: [
        new Integrations.BrowserTracing({
          routingInstrumentation: Sentry.vueRouterInstrumentation(router),    // routerä¸ºå½“å‰SPAçš„è·¯ç”±
          tracingOrigins: ["localhost", "my-site-url.com", /^\//]   //my-site-urlä¸ºapiæ¥å£æœåŠ¡çš„åœ°å€ï¼Œç”¨äºè·Ÿè¸ªapi
        })
      ],
      tracesSampleRate: 1.0
  });
```

### ä¸‰ã€ä¸šåŠ¡/è‡ªå®šä¹‰å¼‚å¸¸æ±‡æŠ¥
å¯¹äºä¸šåŠ¡æ–¹é¢çš„å¼‚å¸¸ï¼Œä¸€èˆ¬éœ€è¦æä¾›å‘ç”Ÿé”™è¯¯ä¿¡æ¯çš„æ‰€æœ‰ç›¸å…³æ“ä½œï¼Œæ¯”å¦‚æ¥å£åœ°å€ï¼Œæ¥å£å‚æ•°ï¼Œå½“å‰ç”¨æˆ·çŠ¶æ€ç­‰ç­‰ï¼Œå› æ­¤éœ€è¦ä¸šåŠ¡è‡ªè¡Œå°†äº§ç”Ÿè¿™ä¸ªä¸šåŠ¡å¼‚å¸¸çš„å½“å‰ä¿¡æ¯å…¨éƒ¨æäº¤åˆ°æ—¥å¿—æœåŠ¡å™¨ä¸­ï¼Œæ¥å®Œæˆè¿œç¨‹bugçš„ä¸€ä¸ªå¤ç°ï¼Œ
è¿™è¾¹å¯ä»¥æä¾›1âƒ£ï¸å…¬å…±çš„æ–¹æ³•ï¼Œé›†æˆåˆ°å½“å‰çš„ç»„ä»¶åº“çš„æ–¹æ³•åº“ä¸­ï¼Œæ¯”å¦‚ğŸˆ¶ï¸ä»¥ä¸‹çš„ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼š
```javascript
  // æ¯”å¦‚åœ¨axiosçš„ç»Ÿä¸€ç½‘ç»œè¯·æ±‚å“åº”å›è°ƒå¤„ç†å‡½æ•°ä¸­
  import { CustomReport } from '@sentry/browser';
  CustomReport.setTags({
      environment: env,
      error: 'æ¥å£å“åº”çš„é”™è¯¯ä¿¡æ¯'
    });
    user && CustomReport.setUser({
      id: user.id,
      username: user.username
    });
    CustomReport.setExtras({
      curl
    })
    CustomReport.withScope(scope => {
      scope.setLevel(CustomReport.Severity.Info);
    });
    CustomReport.captureException(new Error(errorMsg));
```

### å››ã€ç»„ä»¶åº“ç»Ÿä¸€é›†æˆæ–¹æ¡ˆ(æ¨è)
ç›®å‰å‰ç«¯è¿™è¾¹æœ‰ç»Ÿä¸€çš„ç»„ä»¶åº“ï¼Œåœ¨ç»Ÿä¸€çš„ç»„ä»¶åº“ä¸­æ·»åŠ ä¸€ç›®å½•ï¼Œä½œä¸ºæ—¥å¿—ç›‘æ§çš„å…¥å£ï¼Œåªéœ€åœ¨éœ€è¦çš„ä½ç½®ä½¿ç”¨å³å¯ï¼Œç›®å‰è¿™è¾¹è¦æ±‚æ˜¯æ•´ä½“é¡¹ç›®ä½ç½®ä»¥åŠç»Ÿä¸€çš„axiosæ¥å£å“åº”çš„ä½ç½®æ¥æ¥å…¥ï¼š
1. main.jså…¥å£ï¼š
```javascript
  // ...
  import { BugReport } from 'zd-bussiness-component';
  BugReport({
    Vue,  // å½“å‰Vueå®ä¾‹
    router, // å½“å‰vue-routerè·¯ç”±å™¨
    dsn: '',//ä»sentryæ§åˆ¶å°è·å–åˆ°çš„é¡¹ç›®é…ç½®
    debug: true,  //å¼€å‘ç¯å¢ƒå¼€å¯è°ƒè¯•æ¨¡å¼
    environment: 'è¿è¡Œç¯å¢ƒ',
    release: process.env.npm_package_version // å½“å‰ç‰ˆæœ¬å·ï¼Œå¯¹åº”äºç›®å‰package.jsonä¸­çš„versionå­—æ®µ
  });
  // ...
```
é€šè¿‡ä¸Šè¿°çš„é…ç½®ï¼Œå³å¯å®Œæˆå…¨å±€å¼‚å¸¸çš„æ•è·å¹¶ä¸Šä¼ æ—¥å¿—

2. axiosç»Ÿä¸€çš„å›è°ƒå…¥å£ï¼š
```javascript
  //...
  import { report } from 'zd-bussiness-component'; 
  // ç»Ÿä¸€å¤„ç†å“åº”æ‹¦æˆª
  axios.inceptert.use(res => {
  	if('ä¸šåŠ¡å¼‚å¸¸äº†'){
  		report({
  		  env: '',//å½“å‰ç¯å¢ƒ
  		  errorMsg: 'æ¥å£è¿”å›çš„å¼‚å¸¸æç¤ºä¿¡æ¯',
  		  curl: {
  		  	...res,
  		  	params: res.config.data,
  		  	headers: res.config.headers
  		  },
  		  user: å·²ç™»å½•?{id, username}: null,
  		  tag: {} // å¯¹è±¡ç±»å‹çš„è‡ªå®šä¹‰æ ‡ç­¾ï¼Œå¯ç”¨äºè‡ªå®šä¹‰é”™è¯¯æ£€ç´¢
  		})
  	}
  });
```
é€šè¿‡ä¸Šè¿°çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ç²¾å‡†è·å–åˆ°å½“ç³»ç»Ÿå‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œå°†äº§ç”Ÿå¼‚å¸¸çš„ç¬é—´æ‰€æäº¤çš„å‚æ•°ã€è¯·æ±‚å¤´ã€å¼‚å¸¸ä¿¡æ¯ä¸€åŒæäº¤åˆ°Sentryæ§åˆ¶å°ä¸­ï¼Œå¯¹åº”å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„æ•ˆæœï¼š
![å¼‚å¸¸ä¿¡æ¯è·Ÿè¸ª](https://img2.zhidianlife.com/image/2022/02/17/b427597a-352f-4e2c-b2b2-088c3cd97711.png)

### é‚®ä»¶å‘Šè­¦
å®‰è£…å¯¹åº”çš„é‚®ä»¶å‘Šè­¦å®¢æˆ·ç«¯ï¼Œè¿™é‡Œæ¨èç½‘æ˜“é‚®ç®±å¤§å¸ˆï¼Œçœå»äº†è‡ªè¡Œé…ç½®smtpçš„æµç¨‹ï¼š[ç‚¹æˆ‘ä¸‹è½½](https://dashi.163.com/index.html)
