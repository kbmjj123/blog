---
title: js运行机制
author: Zhenggl
date: 2021-03-15 17:46:20
categories:
  - [前端, javascript]
tags:
  - javascript
  - EventLoop
cover_picture:
---

### 一、前言
JS是`单线程`,`单线程`,`单线程`的，为毛是单线程的，这里的单线程是指的在浏览器环境下JS执行引擎是单线程的。

单线程意味着同一时间内只能做一件事，为毛不能有多线程的，这样子可以提高效率啊。

> JS的单线程，与它的用途有关。作为浏览器脚本语言，JS的主要用户就是与用户互动，以及操作DOM。这就决定了它必须只能是单线程的，
> 否则会带来很复杂的同步问题。比如假设同时有两个线程，一个在某个DOM上添加内容，另一个在DOM上删除内容，同时操作同一个DOM，
> 那么浏览器应该以哪个为准来对应渲染页面呢？

因此，为了避免复杂性，从JS一诞生，就只能是单线程的，这个是JS语言的核心特征，将来也不会改变到。

为了利用多核CPU的计算能力，Html5提出WebWorker标准，允许JS脚本创建多个线程，但是子线程完全收主线程的控制，切worker子线程
不得操作DOM，仅能通过发送消息的方式告知主线程来操作DOM。

#### 1、进程与线程
> 进程和线程的主要区别在于他们是不同的操作系统资源管理方式。进程有独立的地址空间，一个进程奔溃后，在保护模式下不会对其他进程
> 产生影响，而线程只是一个进程中的不同执行路径而已，一个进程可以同时有多个不同的线程

一个程序运行，就分配了一个独立的运行的地址空间，进程分配一个或者多个不同的线程，进程是操作系统分配资源的最小单位，线程是CPU调度的最小单位。

#### 2、浏览器是多进程的
打开资源管理器，可以看到浏览器开了很多个进程，每一个tab页都是单独的一个进程，所以一个页面奔溃之后一般不会影响到其他页面

![浏览器是多进程](https://img.91temaichang.com/blog/system-task.png)

浏览器包含以下几个进程：

- Browser进程：浏览器的主进程（负责协调、主控），只有一个
- 第三方插件进程：每个类型的插件对应于一个进程，仅当使用该插件时才创建
- GPU进程：最多一个，用于绘制3D等
- 浏览器渲染进程（浏览器内核）（renderer进程，内部是多线程的）：默认每个Tab标签对应一个进程，互不影响

#### 3、浏览器渲染进程
**浏览器渲染进程是多进程的**，也是一个前端人最关注的，它主要包括有以下几个线程：

- GUI渲染线程
    * 负责渲染浏览器界面，解析HTML，CSS，构建DOM树和RenderObject树，布局和绘制等；
    * 当界面需要重绘(Repaint)或由于某种操作引发回流(reflow)时，该线程就会执行；
    * `GUI渲染线程与JS引擎线程是互斥的`，当JS引擎执行时GUI线程会被挂起，GUI更新会被保存在一个队列中等到JS引擎空闲时立即被执行；
- JS引擎线程
    * 也称为JS内核，负责处理javascript脚本程序；
    * JS引擎线程负责解析javascript，运行代码；
    * JS引擎一直等待着任务队列中任务引擎的到来，然后加以处理，一个Tab页(renderer进程)中无论什么时候都`只有一个JS线程`在运行JS程序；
    * `GUI渲染线程与JS引擎线程是互斥的`，因此如果JS执行时间过长，就会造成页面渲染不连贯，导致页面渲染加载阻塞；
- 事件触发线程
    * 归属于浏览器而不是JS引擎，用来控制事件循环(可以理解为，JS引擎自己都忙不过来，需要浏览器另开线程协助)；
    * 
